#!/usr/bin/env ruby

## org-goals-report
#
#  Author: Andrew Robert McBurney <andrewrobertmcburney@gmail.com>
#  Description: Generates a new report for my goals.
#  Usage:
#
#    org-goals-report

require_relative "models/array"
require_relative "models/category"
require_relative "models/goal"

require_relative "shared/constants"
require_relative "shared/org"
require_relative "shared/ui"

def generate_report!
  date   = Time.now.strftime("%F")
  parser = Org::Parser.new(Const::Org::GOALS_README_PATH)

  h0_headings = parser.headings
  h1_headings = h0_headings.subheadings
  h2_headings = h1_headings.flat_map(&:subheadings)

  categories = h2_headings.map do |h2|
    h3_headings = h2.subheadings

    goals = h3_headings.map do |h3|
      name = h3.text
      description = h3.description
      rating = UI.input("How would you rate your progress on goal #{name}?")

      Model::Goal.new(
        name: name,
        description: description,
        date: date,
        rating: rating.to_i
      )
    end

    Model::Category.new(name: h2.text, goals: goals)
  end

  serialized_categories = categories.serialize!
  org_report_path = File.join(Const::Org::GOALS_REPORTS_PATH, "#{date}.json")
  File.write(org_report_path, serialized_categories)
end

generate_report!
